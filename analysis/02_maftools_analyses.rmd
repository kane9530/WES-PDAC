---
title: "variant_annotation.rmd"
output: html_document
date: "2023-05-30"
---

```{r}
library(RColorBrewer)
library(maftools)
library(ggplot2)
library("BSgenome.Hsapiens.UCSC.hg38", quietly = TRUE)
library('NMF')
library(sigminer)
library(VariantAnnotation)

res_path <- "../results/combined_batches_wes/"
```
# Loading in MAF files

```{r}
maf_files = c()

for (maf_file in list.files("/media/gedac/kane/projects/booney_wes_clean/results/first_batch_wes/maf",
                            full.names=TRUE)){
  mymaf = read.maf(maf=maf_file)
  maf_files = append(maf_files, mymaf)
}

for (maf_file in list.files("/media/gedac/kane/projects/booney_wes_clean/results/second_batch_wes/maf",
                            full.names=TRUE)){
  mymaf = read.maf(maf=maf_file)
  maf_files = append(maf_files, mymaf)
}

merged_maf <- maftools::merge_mafs(maf_files)
# Creating the patient and sample column for better annotation

write.mafSummary(merged_maf, basename="merged_mafs_allBatches_090124")
# Creating the patient and sample column for better annotation
#write.mafSummary(merged_maf, basename="merged_mafs_190923")
```

# Discard PCA117 PDO sample

```{r}
merged_maf <- read.maf("../results/combined_batches_wes/merged_mafs_allBatches_090124_maftools.maf", 
                 verbose=TRUE)
tsb = merged_maf@clinical.data$Tumor_Sample_Barcode[-grep(merged_maf@clinical.data$Tumor_Sample_Barcode, pattern="PCA117_*")]
merged_maf_without_pca117 <- subsetMaf(merged_maf, tsb= tsb)
write.mafSummary(merged_maf_without_pca117, basename="merged_mafs_220923_noPCA117")
```

# Loading MAF file (full)
```{r}
merged_maf <- read.maf("../results/combined_batches_wes/merged_mafs_allBatches_090124_maftools.maf", 
                 verbose=TRUE)

merged_maf@clinical.data <- merged_maf@clinical.data %>%
  tidyr::separate(Tumor_Sample_Barcode, into = c("Patient", "Sample", "Treatment"), sep = "_", remove=FALSE) %>%
  dplyr::mutate(Sample_Label = stringr::str_extract(Sample, "[A-Za-z]+")) %>%
  data.table::setDT()
tissue_samples <- merged_maf@clinical.data$Tumor_Sample_Barcode[grep(merged_maf@clinical.data$Tumor_Sample_Barcode, pattern="*TISSUE$")]
organoid_samples <- merged_maf@clinical.data$Tumor_Sample_Barcode[-grep(merged_maf@clinical.data$Tumor_Sample_Barcode, pattern="*TISSUE$")]

merged_maf_tissue_only <- subsetMaf(merged_maf, tsb= tissue_samples)
merged_maf_organoid_only <- subsetMaf(merged_maf, tsb= organoid_samples)
merged_maf@data %>%
  dplyr::filter(Hugo_Symbol == "TP53")
```

# Exploring sample summary statistics
```{r}
getGeneSummary(merged_maf)
merged_maf@gene.summary
getFields(merged_maf)
merged_maf@data
```
# Creating MAF summary plot
```{r}
png(paste0(res_path,"/mafsummary.png"), units = "in", res = 300, width = 8, height = 10)
plotmafSummary(maf = merged_maf, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE)
dev.off()
```
# Oncoplot 

```{r}
n <- length(unique(merged_maf@clinical.data$Patient))
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
patient_colors <- sample(col_vector, n)
#patient_colors = RColorBrewer::brewer.pal(n =n,name = 'Spectral')
names(patient_colors) = unique(merged_maf@clinical.data$Patient)

treatment_colors = RColorBrewer::brewer.pal(n = length(unique(merged_maf@clinical.data$Treatment)),name = 'Accent')
names(treatment_colors) = unique(merged_maf@clinical.data$Treatment)
treatment_colors

sample_label_colors = c("#F22B6E", "#82BAB9")
names(sample_label_colors) = unique(merged_maf@clinical.data$Sample_Label)

anno_colors = list("Patient" = patient_colors,
  "Treatment" = treatment_colors,
  "Sample_Label" = sample_label_colors)

# Saving oncoplot - not that useful as there are many genes involved
png(paste0(res_path,"/oncoplot.png"), units = "in", res = 300, width = 12, height = 17)
oncoplot(maf = merged_maf, clinicalFeatures=c("Patient","Treatment","Sample_Label"), annotationColor=anno_colors, sortByAnnotation=TRUE, anno_height= 1, top = 100, showTumorSampleBarcodes=TRUE, barcodeSrt = 90, genes=getGeneSummary(merged_maf)$Hugo_Symbol[1:100], barcode_mar=10, showTitle=FALSE, drawBox=TRUE, gene_mar=4, draw_titv=FALSE, annotationFontSize=1.5,
legendFontSize =1.5, SampleNamefontSize=1, fontSize = 0.6, writeMatrix=TRUE)
dev.off()
```
# Oncoplot of genes within COSMIC database

```{r}
data(cgc_67, package = "COSMIC.67")
head(cgc_67)
cosmic_genes <- getGeneSummary(merged_maf)$Hugo_Symbol[getGeneSummary(merged_maf)$Hugo_Symbol %in% cgc_67$SYMBOL]
getGeneSummary(merged_maf)$Hugo_Symbol[1:20]
length(cosmic_genes)
png(paste0(res_path,"/oncoplot_cosmic.png"), units = "in", res = 300, width = 12, height = 17)
oncoplot(maf = merged_maf, genes=cosmic_genes, clinicalFeatures=c("Patient","Treatment","Sample_Label"),altered=TRUE, annotationColor=anno_colors, sortByAnnotation=TRUE, anno_height= 1, showTumorSampleBarcodes=TRUE, barcodeSrt = 90, barcode_mar=10, showTitle=FALSE, drawBox=TRUE, gene_mar=4, draw_titv=FALSE, annotationFontSize=1.5,
legendFontSize =1.5, SampleNamefontSize=1, fontSize = 0.6, writeMatrix=TRUE, drawColBar=FALSE)
dev.off()
```
# Calculate Tumor mutational burden (TMB) score
```{r}
# All PDO + Tissue
png(paste0(res_path,"/tmb_pdac.png"), units = "in", res = 300, width = 12, height = 12)
tmb(maf = merged_maf, captureSize=  36.5, logScale=FALSE)
dev.off()

# Tissue only
png(paste0(res_path,"/tmb_tissueOnly.png"), units = "in", res = 300, width = 12, height = 12)
tmb(maf=merged_maf_tissue_only, captureSize=36.5, logScale=FALSE)
dev.off()

# Organoid only
png(paste0(res_path,"/tmb_OrganoidOnly.png"), units = "in", res = 300, width = 12, height = 12)
tmb(maf=merged_maf_organoid_only, captureSize=36.5, logScale=FALSE)
dev.off()

```
# Titv plot 
```{r}
merged_maf.titv = titv(maf = merged_maf, plot = FALSE, useSyn = FALSE)

png(paste0(res_path,"/titv.png"), units = "in", res = 300, width = 12, height = 12)
plotTiTv(res = merged_maf.titv, showBarcodes=TRUE, textSize=0.6, plotNotch=TRUE)
dev.off()
```

# Lollipop Plot of specific genes
```{r}
genes_lollipop <- c("TP53", "KRAS", "SMAD4", "CDKN2A", "ARID1A", "ATM", "TTN")
lollipop_res <- res_path
for (gene in genes_lollipop){
  png(paste0(lollipop_res,gene,"_lollipop.png"), units = "in", res = 300, width = 8, height = 6)
  lollipopPlot(
  maf = merged_maf,
  labelPos="all",
  gene = gene,
  showMutationRate = TRUE)
  dev.off()
}

merged_maf@data %>%
  dplyr::filter(Hugo_Symbol == "KRAS") %>%
  dplyr::select(HGVSp_Short) %>%
  table()
lollipopPlot(
  maf = merged_maf,
  labelPos="all",
  gene = "KRAS",
  showMutationRate = TRUE)
```
# plotVAF of key genes
```{r}
samples_data_tidy <- merged_maf@data %>%
  tidyr::separate(Tumor_Sample_Barcode, into = c("Patient", "Sample", "Treatment"), sep = "_", remove=FALSE) %>%
  dplyr::mutate(isTissue = ifelse(Treatment=="TISSUE","TISSUE","ORGANOID")) %>%
  dplyr::mutate(vaf = t_alt_count/t_depth)
samples_data_tidy_cosmic <- samples_data_tidy %>%
  dplyr::filter(Hugo_Symbol %in% cosmic_genes[1:12])

color_palette <- c("#08519C", "#3182BD", "#6BAED6", "#BDD7E7", "#FF0000")

png(paste0(res_path,"/vaf.png"), units = "in", res = 300, width = 14, height = 10)
ggplot(samples_data_tidy_cosmic, aes(x=Patient, y=vaf, fill=Treatment))+
  geom_col(position="dodge")+
  scale_fill_manual(values = color_palette) +
  facet_wrap(~Hugo_Symbol) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90))
dev.off()

```

# Rainfall plot
```{r}
merged_maf@clinical.data
rainfallPlot(maf = merged_maf,detectChangePoints = TRUE, pointSize = 0.4)
```

# Somatic interactions
```{r}
somaticInteractions(maf = merged_maf, top = 25, pvalue = c(0.05, 0.1))
```

# Oncodrive
```{r}
laml.sig = oncodrive(maf = merged_maf_cn, minMut = 5, pvalMethod = 'zscore')
plotOncodrive(res = laml.sig, fdrCutOff = 0.1, useFraction = TRUE, labelSize = 0.3, bubbleSize=0.5)
```

# Oncogenic dysregualted pathways
```{r}
OncogenicPathways(maf = merged_maf)
```
# Plot specific oncogenic pathways
```{r}
PlotOncogenicPathways(maf = merged_maf, pathways = "TP53")
```

# Signatures
```{r}
laml.tnm = trinucleotideMatrix(maf = merged_maf,  ref_genome = "BSgenome.Hsapiens.UCSC.hg38")
laml.sign = estimateSignatures(mat = laml.tnm, nTry = 20, pConstant=0.001)
plotCophenetic(res = laml.sign)
laml.sig = extractSignatures(mat = laml.tnm, n = 6, pConstant =0.001)
laml.og30.cosm = compareSignatures(nmfRes = laml.sig, sig_db = "legacy")
pheatmap::pheatmap(mat = laml.og30.cosm$cosine_similarities, cluster_rows = FALSE, main = "cosine similarity against validated signatures")
maftools::plotSignatures(nmfRes = laml.sig, title_size = 1.2, sig_db = "SBS")
getwd()
```
